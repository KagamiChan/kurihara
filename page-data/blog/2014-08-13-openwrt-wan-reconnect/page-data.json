{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/blog/2014-08-13-openwrt-wan-reconnect/","result":{"data":{"site":{"siteMetadata":{"title":"少年读书隙中窥月"}},"markdownRemark":{"id":"13d48d84-9037-5c95-878e-ba82766dc69c","excerpt":"早起发现断网了，登路由器的上 luci 一看，原因是 wan 断线了。于是就上网搜索了一下如何断线自动重连。总结的方法有两个： 使用 pppoe 的 keepalive 属性 这个属性说法是经过多少次连接失败后会自动重连。具体的连接失败貌似是指 lcp echo…","html":"<p>早起发现断网了，登路由器的上 luci 一看，原因是 wan 断线了。于是就上网搜索了一下如何断线自动重连。总结的方法有两个：</p>\n<h3>使用 <a href=\"http://wiki.openwrt.org/doc/uci/network#protocol.pppoe.ppp.over.ethernet\">pppoe 的 keepalive 属性</a></h3>\n<p>这个属性说法是经过多少次连接失败后会自动重连。具体的连接失败貌似是指 lcp echo 的失败。我没想出怎么测试管不管用，姑且设置成为 5 。</p>\n<p>这个设置的 uci 命令是</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">uci <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">network.wan.keepalive</span><span class=\"token operator\">=</span>5uci commit</code></pre></div>\n<p>或者直接修改 luci wan 界面的 LCP echo failure threshold 一项。</p>\n<h3>使用自定义的检测脚本</h3>\n<p>综合参考了几个感觉很深奥，脚本很复杂的文章之后，我用了这么一个脚本：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token shebang important\">#! /bin/shif ! ping -c 1 114.114.114.114 > /dev/nullthen ifup wanfi</span></code></pre></div>\n<p>该脚本的原理是 ping 114.114.114.114，如果没有通的话，则自动重连 wan。这个脚本的文件名和文件位置是随意的。我自己是放在了 /etc/config/reconnect.sh。然后在 luci 的  Scheduled Tasks 里边加入一行</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\\*/1 \\* \\* \\* \\* /etc/config/reconnect.sh</code></pre></div>\n<p>之后重启路由或者执行</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">/etc/init.d/cron restart</code></pre></div>\n<p>其结果就是每分钟执行一次 reconnect.sh 脚本</p>","frontmatter":{"title":"Openwrt wan 的断线重连","publish_date":"2014-08-13T12:26:49.000+08:00","revise_date":"2014-08-13T12:26:49.000+08:00","draft":false}}},"pageContext":{"previous":{"id":"faabbe39-a07c-5fb6-8923-e1229472f911","fields":{"slug":"/blog/2014-08-01-source-han-sans/","type":"blog","timeToRead":{"words":727,"minutes":5}},"frontmatter":{"title":"思源黑体","publish_date":"2014-08-01T16:44:26.000+08:00"}},"slug":"/blog/2014-08-13-openwrt-wan-reconnect/"}},"staticQueryHashes":["1330398833","2356112386"],"slicesMap":{}}